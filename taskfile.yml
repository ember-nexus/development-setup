version: '3'

env:
  repositories:
    - name: "api"
      github: ember-nexus/api
      location: "api/api"
    - name: "reference-dataset"
      github: ember-nexus/reference-dataset
      location: "api/reference-dataset"
    - name: "web-sdk"
      github: ember-nexus/web-sdk
      location: "frontend/web-sdk"
  #  repositories-old:
  #    api:
  #      - ember-nexus/api
  #      - ember-nexus/reference-dataset
  #
  #    frontend:
  #      - ember-nexus/web-sdk
  #      - ember-nexus/uix
  #      - ember-nexus/app-plugin-experimental
  #      - ember-nexus/app-web
  #
  #    other:
  #      - ember-nexus/governance
  #      - ember-nexus/python-sdk

tasks:

  default:
    desc: Default help output.
    cmds:
      - task --list

  setup:
    desc: Check required dependencies and clones all Ember Nexus repositories.
    cmds:
      - task: check-docker-is-installed
      - task: check-docker-compose-is-installed
      - task: clone-repositories


  check-docker-is-installed:
    internal: true
    silent: true
    cmd: |
      if [ -x "$(command -v docker)" ]; then
        echo "[OK] docker is installed"
      else
        echo "[ERROR] unable to find docker, please install it."
        echo "        see tutorial here: https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-22-04"
        exit 1
      fi

  check-docker-compose-is-installed:
    internal: true
    silent: true
    cmd: |
      if $(docker compose &>/dev/null) && [ $? -eq 0 ]; then
        echo "[OK] docker compose is installed"
      else
        echo "[ERROR] unable to find docker compose, please install it."
        echo "        see tutorial here: https://docs.docker.com/compose/install/linux/"
        exit 1
      fi

  clone-repositories:
    internal: true
    silent: true
    cmds:
      - for: { var: repositories }
        cmd: |
          mkdir -p "./{{.ITEM.location}}"
          echo "[WIP] cloning {{.ITEM.name}}..."
          git clone "git@github.com:{{.ITEM.github}}.git" "./{{.ITEM.location}}"
